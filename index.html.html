<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tulum – Tabla + Gráficas + Inputs (MXN/USD)</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .sub { margin: 0 0 12px 0; color: #374151; }
    .controls {
      display: grid;
      grid-template-columns: repeat(6, minmax(160px, 1fr));
      gap: 12px;
      margin: 10px 0 14px 0;
    }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.05);
    }
    .label { font-size: 12px; color: #6b7280; margin-bottom: 6px; }
    .value { font-size: 18px; font-weight: 700; }
    .input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 12px;
      margin: 10px 0 18px 0;
    }
    .charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 12px 0 20px 0;
    }
    .chart-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.05);
    }
    .chart-title { font-weight: 700; margin: 6px 0 10px 2px; }
    @media (max-width: 1200px) {
      .charts { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(2, minmax(180px, 1fr)); }
      .controls { grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }
  </style>
</head>

<body>
  <h2>Tabla dinámica (interés simple) – Tulum</h2>
  <p class="sub" id="subtitle"></p>

  <!-- CONTROLES -->
  <div class="controls">
    <div class="card">
      <div class="label">Fracciones</div>
      <input id="inp_fracciones" class="input" type="number" min="1" step="1" value="2">
    </div>

    <div class="card">
      <div class="label">Rendimiento anual (%)</div>
      <input id="inp_rend" class="input" type="number" step="0.1" value="10.0">
    </div>

    <div class="card">
      <div class="label">Plusvalía anual (%)</div>
      <input id="inp_plus" class="input" type="number" step="0.1" value="15.0">
    </div>

    <div class="card">
      <div class="label">Año para texto</div>
      <input id="inp_anio_anotar" class="input" type="number" min="1" step="1" value="4">
    </div>

    <div class="card">
      <div class="label">Moneda</div>
      <select id="inp_moneda" class="input">
        <option value="MXN">MXN</option>
        <option value="USD">USD</option>
      </select>
    </div>

    <div class="card">
      <div class="label">Tipo de cambio (MXN por 1 USD)</div>
      <input id="inp_fx" class="input" type="number" step="0.01" value="17.2">
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="card">
      <div class="label">Precio por fracción</div>
      <div class="value" id="kpi_precio_frac"></div>
    </div>
    <div class="card">
      <div class="label">Inversión inicial</div>
      <div class="value" id="kpi_inversion"></div>
    </div>
    <div class="card">
      <div class="label">Rendimiento (simple)</div>
      <div class="value" id="kpi_rend"></div>
    </div>
    <div class="card">
      <div class="label">Plusvalía (simple)</div>
      <div class="value" id="kpi_plus"></div>
    </div>
  </div>

  <!-- GRÁFICAS -->
  <div class="charts">
    <div class="chart-card">
      <div class="chart-title">Gráfica: Rendimiento (ganancia acumulada)</div>
      <div id="chart_rend"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Gráfica: Plusvalía (venta estimada)</div>
      <div id="chart_plus"></div>
    </div>
  </div>

  <!-- TABLA -->
  <table id="tabla" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Año</th>
        <th>Rendimiento (ganancia)</th>
        <th>Total con rendimiento</th>
        <th>Plusvalía (ganancia)</th>
        <th>Venta estimada</th>
        <th>Venta por fracción</th>
      </tr>
    </thead>
    <tbody id="tbody_tabla"></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <script>
    const PRICE_PER_FRACTION_MXN = 500000;
    const ANIOS = [1, 2, 3, 4, 5, 10, 15];

    function fmtMoney(n, moneda) {
      return new Intl.NumberFormat('es-MX', { style:'currency', currency: moneda }).format(n);
    }
    function montoSimple(principal, tasaDecimal, anios) {
      return principal * (1 + tasaDecimal * anios);
    }

    let dataTable = null;

    function rebuild() {
      const fracciones = Math.max((1), parseInt(document.getElementById('inp_fracciones').value || '1', 10));
      const rendPct = parseFloat(document.getElementById('inp_rend').value || '0');
      const plusPct = parseFloat(document.getElementById('inp_plus').value || '0');
      const anioAnotar = Math.max(1, parseInt(document.getElementById('inp_anio_anotar').value || '1', 10));
      const moneda = document.getElementById('inp_moneda').value || 'MXN';
      const fx = Math.max(0.0001, parseFloat(document.getElementById('inp_fx').value || '17'));

      const inversion_mxn = fracciones * PRICE_PER_FRACTION_MXN;
      const r = rendPct / 100.0;
      const g = plusPct / 100.0;

      // Conversión
      const conv = (monto_mxn) => (moneda === 'USD' ? (monto_mxn / fx) : monto_mxn);

      const inversion = conv(inversion_mxn);
      const precio_frac = conv(PRICE_PER_FRACTION_MXN);

      document.getElementById('subtitle').innerHTML =
        "<b>Fracciones:</b> " + fracciones +
        " &nbsp;|&nbsp; <b>Inversión inicial:</b> " + fmtMoney(inversion, moneda) +
        " &nbsp;|&nbsp; <b>Rendimiento anual:</b> " + rendPct.toFixed(2) + "%" +
        " &nbsp;|&nbsp; <b>Plusvalía anual:</b> " + plusPct.toFixed(2) + "%" +
        " &nbsp;|&nbsp; <b>Moneda:</b> " + moneda +
        (moneda === "USD" ? (" (FX: " + fx.toFixed(2) + " MXN/USD)") : "");

      document.getElementById('kpi_precio_frac').textContent = fmtMoney(precio_frac, moneda);
      document.getElementById('kpi_inversion').textContent = fmtMoney(inversion, moneda);
      document.getElementById('kpi_rend').textContent = rendPct.toFixed(2) + "%";
      document.getElementById('kpi_plus').textContent = plusPct.toFixed(2) + "%";

      const tbody = document.getElementById('tbody_tabla');
      tbody.innerHTML = "";

      const x = [];
      const yRend = [];
      const yPlus = [];

      for (const a of ANIOS) {
        // Calculamos en MXN y luego convertimos a la moneda final
        const totalR_mxn = montoSimple(inversion_mxn, r, a);
        const ganR_mxn = totalR_mxn - inversion_mxn;

        const venta_mxn = montoSimple(inversion_mxn, g, a);
        const ganP_mxn = venta_mxn - inversion_mxn;

        const ventaFrac_mxn = montoSimple(PRICE_PER_FRACTION_MXN, g, a);

        const totalR = conv(totalR_mxn);
        const ganR = conv(ganR_mxn);
        const venta = conv(venta_mxn);
        const ganP = conv(ganP_mxn);
        const ventaFrac = conv(ventaFrac_mxn);

        x.push(a);
        yRend.push(ganR);
        yPlus.push(venta);

        const tr = document.createElement('tr');
        tr.innerHTML =
          "<td>" + a + "</td>" +
          "<td>" + fmtMoney(ganR, moneda) + "</td>" +
          "<td>" + fmtMoney(totalR, moneda) + "</td>" +
          "<td>" + fmtMoney(ganP, moneda) + "</td>" +
          "<td>" + fmtMoney(venta, moneda) + "</td>" +
          "<td>" + fmtMoney(ventaFrac, moneda) + "</td>";
        tbody.appendChild(tr);
      }

      if (dataTable) dataTable.destroy();
      dataTable = $('#tabla').DataTable({
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        order: [[0, 'asc']],
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ filas",
          info: "Mostrando _START_ a _END_ de _TOTAL_",
          infoEmpty: "Sin datos",
          infoFiltered: "(filtrado de _MAX_ en total)",
          paginate: { first: "Primero", last: "Último", next: "Siguiente", previous: "Anterior" }
        }
      });

      let idx = x.indexOf(anioAnotar);
      if (idx === -1) idx = x.length - 1;

      const traceR = {
        x: x, y: yRend,
        mode: 'lines+markers',
        name: 'Rendimiento (ganancia)',
        hovertemplate: "Año=%{x}<br>Rendimiento=%{y:,.0f} " + moneda + "<extra></extra>"
      };
      const layoutR = {
        margin: {t: 10, r: 10, b: 45, l: 60},
        xaxis: {title: 'Años'},
        yaxis: {title: 'Rendimiento acumulado (' + moneda + ')'},
        hovermode: 'x unified',
        annotations: [{
          x: x[idx],
          y: yRend[idx],
          text: "Este sería tu rendimiento en año " + x[idx] + ": " + fmtMoney(yRend[idx], moneda),
          showarrow: true, arrowhead: 3, ax: 0, ay: -40
        }]
      };
      Plotly.newPlot('chart_rend', [traceR], layoutR, {displayModeBar: true, responsive: true});

      const traceP = {
        x: x, y: yPlus,
        mode: 'lines+markers',
        name: 'Venta estimada',
        hovertemplate: "Año=%{x}<br>Venta=%{y:,.0f} " + moneda + "<extra></extra>"
      };
      const layoutP = {
        margin: {t: 10, r: 10, b: 45, l: 60},
        xaxis: {title: 'Años'},
        yaxis: {title: 'Precio estimado de venta (' + moneda + ')'},
        hovermode: 'x unified',
        shapes: [{
          type: 'line',
          x0: Math.min(...x), x1: Math.max(...x),
          y0: inversion, y1: inversion,
          line: {dash: 'dash', width: 1}
        }],
        annotations: [{
          x: x[idx],
          y: yPlus[idx],
          text: "A esto venderías tu fracción en año " + x[idx] + ": " + fmtMoney(yPlus[idx], moneda),
          showarrow: true, arrowhead: 3, ax: 0, ay: -40
        },{
          x: x[Math.floor(x.length/2)],
          y: inversion,
          text: "Inversión inicial",
          showarrow: false,
          yshift: 10
        }]
      };
      Plotly.newPlot('chart_plus', [traceP], layoutP, {displayModeBar: true, responsive: true});
    }

    ['inp_fracciones','inp_rend','inp_plus','inp_anio_anotar','inp_moneda','inp_fx'].forEach(id => {
      document.getElementById(id).addEventListener('input', rebuild);
      document.getElementById(id).addEventListener('change', rebuild);
    });

    window.addEventListener('load', () => {
      document.getElementById('inp_moneda').value = "MXN";
      rebuild();
    });
  </script>
</body>
</html>
